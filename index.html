<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alie's Song Quiz</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #1a0a12;
      --surface: #241018;
      --surface2: #2e1420;
      --surface3: #3a1828;
      --accent: #ff4fa3;
      --accent2: #ff85c2;
      --accent3: #c0185e;
      --glow: rgba(255,79,163,0.25);
      --text: #ffe6f3;
      --muted: #a06080;
      --success: #50c878;
      --danger: #e05555;
      --gold: #ffd700;
      --radius: 14px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      background-image:
        radial-gradient(ellipse at 20% 20%, rgba(255,79,163,0.08) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(192,24,94,0.06) 0%, transparent 50%);
      font-family: 'DM Sans', sans-serif;
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 24px 16px 60px;
    }

    .app {
      width: 100%;
      max-width: 500px;
    }

    header {
      text-align: center;
      margin-bottom: 32px;
    }

    header h1 {
      font-family: 'Playfair Display', serif;
      font-size: 2.8rem;
      font-weight: 900;
      letter-spacing: 1px;
      background: linear-gradient(135deg, var(--accent2), var(--accent), var(--accent3));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: none;
      filter: drop-shadow(0 0 20px var(--glow));
    }

    header p {
      color: var(--muted);
      font-size: 0.85rem;
      margin-top: 6px;
      letter-spacing: 0.5px;
    }

    .card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 22px;
      margin-bottom: 16px;
      border: 1px solid rgba(255,79,163,0.15);
      box-shadow: 0 4px 24px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.04);
    }

    .card h2 {
      font-family: 'Playfair Display', serif;
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--accent2);
      margin-bottom: 14px;
      letter-spacing: 0.5px;
    }

    input {
      width: 100%;
      padding: 11px 14px;
      background: var(--surface2);
      border: 1px solid rgba(255,79,163,0.2);
      border-radius: 9px;
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      font-size: 0.95rem;
      margin-bottom: 10px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(255,79,163,0.15);
    }

    input::placeholder { color: var(--muted); }
    input:disabled { opacity: 0.45; cursor: not-allowed; }

    .btn {
      display: block;
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 9px;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.15s, transform 0.1s, box-shadow 0.2s;
      margin-bottom: 8px;
      letter-spacing: 0.3px;
    }

    .btn:hover { opacity: 0.88; transform: translateY(-1px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
    .btn:active { transform: translateY(0); }
    .btn:disabled { opacity: 0.35; cursor: not-allowed; transform: none; box-shadow: none; }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent3));
      color: #fff;
      box-shadow: 0 4px 16px rgba(255,79,163,0.35);
    }

    .btn-ghost {
      background: var(--surface2);
      color: var(--text);
      border: 1px solid rgba(255,79,163,0.25);
    }

    .btn-success { background: linear-gradient(135deg, #38b85a, #50c878); color: #fff; }
    .btn-danger { background: linear-gradient(135deg, var(--danger), #c03030); color: #fff; }
    .btn-gold { background: linear-gradient(135deg, #c8a800, var(--gold)); color: #111; font-weight: 700; }

    .btn-small {
      display: inline-block;
      width: auto;
      padding: 5px 13px;
      font-size: 0.78rem;
      margin: 3px 3px 0 0;
      margin-bottom: 0;
    }

    .status-msg {
      font-size: 0.85rem;
      color: var(--muted);
      margin-top: 6px;
      min-height: 20px;
    }

    .status-msg.ok { color: var(--success); }
    .status-msg.err { color: var(--danger); }

    .lobby-code-display {
      background: var(--surface2);
      border-radius: 10px;
      padding: 14px;
      text-align: center;
      margin-bottom: 14px;
      border: 1px solid rgba(255,79,163,0.12);
    }

    .lobby-code-display .code {
      font-family: 'Playfair Display', serif;
      font-size: 2.8rem;
      font-weight: 900;
      letter-spacing: 10px;
      color: var(--accent);
      filter: drop-shadow(0 0 10px var(--glow));
    }

    .lobby-code-display .label {
      font-size: 0.72rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 4px;
    }

    .round-badge {
      display: inline-block;
      background: linear-gradient(135deg, var(--accent3), var(--accent));
      color: #fff;
      border-radius: 20px;
      padding: 4px 14px;
      font-size: 0.8rem;
      font-weight: 700;
      margin-bottom: 14px;
      letter-spacing: 0.5px;
    }

    .locked-notice {
      background: rgba(224,85,85,0.12);
      border: 1px solid rgba(224,85,85,0.25);
      border-radius: 9px;
      padding: 10px;
      text-align: center;
      font-size: 0.85rem;
      color: #e09898;
      margin-bottom: 10px;
    }

    .player-entry {
      background: var(--surface2);
      border-radius: 11px;
      padding: 13px 15px;
      margin-bottom: 10px;
      border: 1px solid rgba(255,79,163,0.08);
      transition: border-color 0.2s;
    }

    .player-entry:hover { border-color: rgba(255,79,163,0.2); }

    .player-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .player-name {
      font-weight: 600;
      font-size: 1rem;
    }

    .player-score {
      background: linear-gradient(135deg, var(--accent), var(--accent3));
      color: #fff;
      font-weight: 700;
      font-size: 0.8rem;
      border-radius: 20px;
      padding: 3px 12px;
    }

    .answer-reveal {
      background: rgba(255,255,255,0.03);
      border-radius: 7px;
      padding: 8px 11px;
      font-size: 0.85rem;
      margin-bottom: 8px;
      border: 1px solid rgba(255,79,163,0.06);
    }

    .answer-reveal .label {
      color: var(--muted);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }

    .answer-reveal .val {
      color: var(--text);
      margin-top: 2px;
    }

    .answer-reveal .val.empty { color: var(--muted); font-style: italic; }

    .host-row { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 6px; }

    .host-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .host-actions .btn { margin-bottom: 0; }

    /* ‚îÄ‚îÄ‚îÄ HOST SONG INPUT ‚îÄ‚îÄ‚îÄ */
    .song-input-group {
      background: var(--surface2);
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 14px;
      border: 1px solid rgba(255,79,163,0.18);
    }

    .song-input-group .sig-label {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--muted);
      margin-bottom: 10px;
    }

    .song-input-group input {
      margin-bottom: 8px;
      background: var(--surface3);
      border-color: rgba(255,79,163,0.15);
    }

    .song-input-group input:last-of-type { margin-bottom: 0; }

    .song-saved-notice {
      font-size: 0.78rem;
      color: var(--success);
      margin-top: 6px;
      min-height: 16px;
      transition: opacity 0.3s;
    }

    /* ‚îÄ‚îÄ‚îÄ REJOIN BANNER ‚îÄ‚îÄ‚îÄ */
    #rejoinBanner {
      background: linear-gradient(135deg, rgba(255,79,163,0.15), rgba(192,24,94,0.1));
      border: 1px solid rgba(255,79,163,0.3);
      border-radius: 12px;
      padding: 16px 18px;
      margin-bottom: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #rejoinBanner .rj-title {
      font-weight: 700;
      font-size: 0.95rem;
      color: var(--accent2);
    }

    #rejoinBanner .rj-sub {
      font-size: 0.82rem;
      color: var(--muted);
      margin-top: -6px;
    }

    #rejoinBanner .rj-btns {
      display: flex;
      gap: 8px;
    }

    #rejoinBanner .rj-btns .btn {
      margin-bottom: 0;
      flex: 1;
      padding: 9px;
      font-size: 0.85rem;
    }

    .divider {
      border: none;
      border-top: 1px solid rgba(255,79,163,0.1);
      margin: 18px 0;
    }

    .hidden { display: none !important; }

    /* ‚îÄ‚îÄ‚îÄ QR CODE PANEL ‚îÄ‚îÄ‚îÄ */
    .qr-panel {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      margin-bottom: 14px;
      border: 2px solid rgba(255,79,163,0.3);
      animation: fadeInScreen 0.3s ease;
    }

    .qr-panel .qr-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: #a06080;
      margin-bottom: 10px;
    }

    .qr-panel canvas, .qr-panel img {
      display: block;
      margin: 0 auto;
      border-radius: 6px;
    }

    .qr-panel .qr-url {
      font-size: 0.72rem;
      color: #888;
      margin-top: 8px;
      word-break: break-all;
    }

    .qr-btn-row {
      display: flex;
      gap: 8px;
      margin-bottom: 14px;
    }

    .qr-btn-row .btn {
      margin-bottom: 0;
      flex: 1;
      font-size: 0.85rem;
      padding: 9px;
    }

    /* ‚îÄ‚îÄ‚îÄ PDF EXPORT BUTTON on results ‚îÄ‚îÄ‚îÄ */
    .res-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 420px;
      width: 100%;
      margin-top: 24px;
    }

    .res-actions .btn { margin-bottom: 0; }
    #transitionScreen {
      position: fixed;
      inset: 0;
      background: radial-gradient(ellipse at center, #2a0a1a 0%, #0d0208 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 100;
      padding: 32px;
      text-align: center;
      animation: fadeInScreen 0.4s ease;
    }

    @keyframes fadeInScreen {
      from { opacity: 0; transform: scale(0.97); }
      to { opacity: 1; transform: scale(1); }
    }

    #transitionScreen .ts-eyebrow {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 3px;
      color: var(--muted);
      margin-bottom: 16px;
    }

    #transitionScreen .ts-title {
      font-family: 'Playfair Display', serif;
      font-size: 2rem;
      font-weight: 900;
      color: var(--accent2);
      margin-bottom: 10px;
      filter: drop-shadow(0 0 18px var(--glow));
    }

    #transitionScreen .ts-answer-box {
      background: var(--surface);
      border: 2px solid rgba(255,79,163,0.3);
      border-radius: 14px;
      padding: 20px 28px;
      margin: 18px 0;
      max-width: 380px;
      width: 100%;
    }

    #transitionScreen .ts-answer-label {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    #transitionScreen .ts-answer-placeholder {
      font-family: 'Playfair Display', serif;
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--accent);
      font-style: italic;
      letter-spacing: 0.5px;
    }

    #transitionScreen .ts-hint {
      color: var(--muted);
      font-size: 0.82rem;
      margin-bottom: 24px;
    }

    #transitionScreen .ts-btn {
      background: linear-gradient(135deg, var(--accent), var(--accent3));
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 13px 32px;
      font-family: 'DM Sans', sans-serif;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(255,79,163,0.4);
      transition: opacity 0.15s, transform 0.1s;
    }

    #transitionScreen .ts-btn:hover { opacity: 0.9; transform: translateY(-1px); }

    /* ‚îÄ‚îÄ‚îÄ RESULTS SCREEN ‚îÄ‚îÄ‚îÄ */
    #resultsScreen {
      position: fixed;
      inset: 0;
      background: radial-gradient(ellipse at center, #1a0810 0%, #0a0206 100%);
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      z-index: 200;
      padding: 32px 20px 60px;
      overflow-y: auto;
      animation: fadeInScreen 0.5s ease;
    }

    #resultsScreen .res-title {
      font-family: 'Playfair Display', serif;
      font-size: 2.4rem;
      font-weight: 900;
      text-align: center;
      margin-bottom: 6px;
      background: linear-gradient(135deg, var(--gold), #ffb347);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      filter: drop-shadow(0 0 20px rgba(255,215,0,0.4));
    }

    #resultsScreen .res-subtitle {
      color: var(--muted);
      font-size: 0.85rem;
      text-align: center;
      margin-bottom: 28px;
    }

    .podium-entry {
      width: 100%;
      max-width: 420px;
      background: var(--surface);
      border-radius: 13px;
      padding: 16px 20px;
      margin-bottom: 12px;
      border: 1px solid rgba(255,79,163,0.15);
      display: flex;
      align-items: center;
      gap: 16px;
      animation: slideIn 0.4s ease forwards;
      opacity: 0;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .podium-entry.rank-1 {
      border-color: rgba(255,215,0,0.4);
      background: linear-gradient(135deg, var(--surface), rgba(255,215,0,0.06));
    }

    .podium-rank {
      font-family: 'Playfair Display', serif;
      font-size: 1.6rem;
      font-weight: 900;
      min-width: 44px;
      text-align: center;
    }

    .rank-1 .podium-rank { color: var(--gold); }
    .rank-2 .podium-rank { color: #c0c0c0; }
    .rank-3 .podium-rank { color: #cd7f32; }

    .podium-info { flex: 1; }

    .podium-name {
      font-weight: 600;
      font-size: 1.05rem;
      margin-bottom: 2px;
    }

    .podium-score {
      color: var(--muted);
      font-size: 0.82rem;
    }

    .podium-score-badge {
      background: linear-gradient(135deg, var(--accent), var(--accent3));
      color: #fff;
      font-weight: 700;
      font-size: 1rem;
      border-radius: 20px;
      padding: 5px 16px;
    }

    .rank-1 .podium-score-badge {
      background: linear-gradient(135deg, #c8a800, var(--gold));
      color: #111;
    }

    .res-close-btn {
      margin-top: 24px;
      max-width: 420px;
      width: 100%;
    }

    .confetti-dot {
      position: fixed;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      pointer-events: none;
      animation: confettiFall linear forwards;
      z-index: 201;
    }

    @keyframes confettiFall {
      0% { transform: translateY(-20px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(110vh) rotate(720deg); opacity: 0; }
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>üéµ Alie's Song Quiz</h1>
    <p>Host a round. Guess the track.</p>
  </header>

  <!-- REJOIN BANNER -->
  <div id="rejoinBanner" class="hidden">
    <div class="rj-title">üëã Welcome back!</div>
    <div class="rj-sub" id="rejoinSub">You were in a game. Want to rejoin?</div>
    <div class="rj-btns">
      <button class="btn btn-primary" onclick="doRejoin()">Rejoin Game</button>
      <button class="btn btn-ghost" onclick="dismissRejoin()">Dismiss</button>
    </div>
  </div>

  <!-- LANDING -->
  <div id="sectionLanding">
    <div class="card">
      <h2>Create Lobby</h2>
      <button class="btn btn-primary" onclick="createLobby()">‚ú® New Lobby</button>
      <p class="status-msg" id="createStatus"></p>
    </div>

    <div class="card">
      <h2>Join Game</h2>
      <input id="playerName" placeholder="Your display name" maxlength="24">
      <input id="joinCode" placeholder="Lobby code (e.g. AB12CD)" maxlength="6" style="text-transform:uppercase">
      <button class="btn btn-primary" onclick="joinLobby()">Join ‚Üí</button>
      <p class="status-msg" id="joinStatus"></p>
    </div>
  </div>

  <!-- IN GAME -->
  <div id="sectionGame" class="hidden">

    <div class="card" id="lobbyInfoCard">
      <div class="lobby-code-display">
        <div class="label">Lobby Code</div>
        <div class="code" id="displayCode">‚Äî‚Äî</div>
      </div>
      <!-- QR code toggle (host only) -->
      <div id="qrBtnRow" class="qr-btn-row hidden">
        <button class="btn btn-ghost" onclick="toggleQR()" id="btnToggleQR">üì± Show QR Code</button>
      </div>
      <div id="qrPanel" class="qr-panel hidden">
        <div class="qr-label">Scan to join this game</div>
        <div id="qrContainer"></div>
        <div class="qr-url" id="qrUrl"></div>
      </div>
      <div class="round-badge" id="roundBadge">Round 1</div>

      <!-- HOST controls -->
      <div id="hostControls" class="hidden">
        <div class="song-input-group">
          <div class="sig-label">üéµ This Round's Song</div>
          <input id="hostCorrectArtist" placeholder="Correct artist‚Ä¶" oninput="saveSongAnswer()">
          <input id="hostCorrectTitle" placeholder="Correct song title‚Ä¶" oninput="saveSongAnswer()">
          <div class="song-saved-notice" id="songSavedNotice"></div>
        </div>
        <div class="host-actions">
          <button class="btn btn-success" onclick="unlockRound()" id="btnUnlock">‚ñ∂ Start Round</button>
          <button class="btn btn-ghost" onclick="showTransitionScreen()" id="btnNext">‚è≠ Next Round</button>
          <button class="btn btn-gold" onclick="endGame()" id="btnEndGame">üèÜ End Game & Results</button>
        </div>
      </div>
      </div>

      <!-- PLAYER answer area -->
      <div id="playerAnswerArea" class="hidden">
        <div id="roundLockedNotice" class="locked-notice hidden">‚è≥ Waiting for host to start round‚Ä¶</div>
        <input id="answerArtist" placeholder="üé§ Artist name‚Ä¶">
        <input id="answerTitle" placeholder="üéµ Song title‚Ä¶">
        <button class="btn btn-primary" onclick="submitAnswer()" id="btnSubmit">Submit Answer</button>
        <p class="status-msg" id="answerStatus"></p>
      </div>
    </div>

    <!-- Player list -->
    <div class="card">
      <h2>Players</h2>
      <div id="playerList"></div>
    </div>
  </div>
</div>

<!-- TRANSITION SCREEN (host only, full screen overlay) -->
<div id="transitionScreen" class="hidden">
  <div class="ts-eyebrow">Round Complete</div>
  <div class="ts-title" id="tsRoundLabel">Round 1</div>
  <div class="ts-answer-box">
    <div class="ts-answer-label">The correct answer was‚Ä¶</div>
    <div class="ts-answer-placeholder" id="tsCorrectArtist" style="font-size:1rem;color:var(--muted);font-style:normal">üé§ <span style="font-style:italic">Artist</span></div>
    <div class="ts-answer-placeholder" id="tsCorrectTitle" style="margin-top:6px">üéµ <span style="font-style:italic">Song Title</span></div>
  </div>
  <p class="ts-hint" id="tsHintHost">Reveal the answer to your players, then continue.</p>
  <button class="ts-btn" id="tsBtnHost" onclick="proceedToNextRound()">Continue to Round <span id="tsNextRoundNum">2</span> ‚Üí</button>
  <button class="ts-btn" id="tsBtnPlayer" onclick="playerDismissTransition()" style="background:rgba(255,255,255,0.1);box-shadow:none;">Got it! ‚úì</button>
</div>

<!-- RESULTS SCREEN -->
<div id="resultsScreen" class="hidden">
  <div class="res-title">üèÜ Final Results</div>
  <div class="res-subtitle">Thanks for playing ‚Äî here's how everyone did!</div>
  <div id="podiumList"></div>
  <div class="res-actions">
    <button class="btn btn-primary" onclick="exportPDF()">üìÑ Export Answer Sheet (PDF)</button>
    <button class="btn btn-ghost" onclick="closeResults()">‚Üê Back to Lobby</button>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<!-- QR Code -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
/* ‚îÄ‚îÄ Firebase ‚îÄ‚îÄ */
firebase.initializeApp({
  apiKey: "AIzaSyDtEl046HxySRHfczOpvca0ybifAWN4FSw",
  authDomain: "song-quix.firebaseapp.com",
  databaseURL: "https://song-quix-default-rtdb.firebaseio.com",
  projectId: "song-quix",
  storageBucket: "song-quix.firebasestorage.app",
  messagingSenderId: "755583525637",
  appId: "1:755583525637:web:d93d6be19afcfba08bcd6c"
});
const db = firebase.database();

/* ‚îÄ‚îÄ State ‚îÄ‚îÄ */
let lobbyCode = null;
let myPlayerId = null;
let isHost = false;
let currentRound = 1;
let roundLocked = true;
let songSaveTimer = null;

/* ‚îÄ‚îÄ Util ‚îÄ‚îÄ */
const $ = id => document.getElementById(id);
function genCode() { return Math.random().toString(36).substring(2, 8).toUpperCase(); }
function show(id) { $(id).classList.remove('hidden'); }
function hide(id) { $(id).classList.add('hidden'); }
function setStatus(id, msg, type = '') {
  const el = $(id);
  el.textContent = msg;
  el.className = 'status-msg' + (type ? ' ' + type : '');
}

/* ‚îÄ‚îÄ On page load: check rejoin + auto-fill join code from URL ‚îÄ‚îÄ */
window.addEventListener('DOMContentLoaded', () => {
  // Auto-fill code from ?join= param
  const params = new URLSearchParams(window.location.search);
  const joinParam = params.get('join');
  if (joinParam) {
    $('joinCode').value = joinParam.toUpperCase();
    $('playerName').focus();
  }

  // Check for saved session to rejoin
  const saved = getSavedSession();
  if (saved) {
    db.ref('lobbies/' + saved.code).once('value').then(snap => {
      if (!snap.exists() || snap.val()?.gameOver) { clearSavedSession(); return; }
      const lobby = snap.val();
      if (!saved.isHost && !lobby.players?.[saved.playerId]) { clearSavedSession(); return; }
      $('rejoinSub').textContent = `You were in lobby ${saved.code} as ${saved.isHost ? 'host' : saved.playerName}.`;
      show('rejoinBanner');
    }).catch(() => clearSavedSession());
  }
});

function getSavedSession() {
  try {
    const raw = localStorage.getItem('songQuizSession');
    return raw ? JSON.parse(raw) : null;
  } catch { return null; }
}

function saveSession() {
  try {
    localStorage.setItem('songQuizSession', JSON.stringify({
      code: lobbyCode,
      playerId: myPlayerId,
      playerName: isHost ? null : $('playerName')?.value?.trim() || '',
      isHost
    }));
  } catch {}
}

function clearSavedSession() {
  try { localStorage.removeItem('songQuizSession'); } catch {}
}

function doRejoin() {
  const saved = getSavedSession();
  if (!saved) return;
  hide('rejoinBanner');

  lobbyCode = saved.code;
  isHost = saved.isHost;
  myPlayerId = saved.playerId;

  enterGame(saved.code);
}

function dismissRejoin() {
  clearSavedSession();
  hide('rejoinBanner');
}

/* ‚îÄ‚îÄ Create Lobby ‚îÄ‚îÄ */
function createLobby() {
  const code = genCode();
  lobbyCode = code;
  isHost = true;
  myPlayerId = null;

  db.ref('lobbies/' + code).set({
    status: 'open',
    round: 1,
    roundLocked: true,
    gameOver: false,
    songs: {}
  }).then(() => {
    saveSession();
    enterGame(code);
    setStatus('createStatus', 'Lobby created!', 'ok');
  }).catch(e => setStatus('createStatus', 'Error: ' + e.message, 'err'));
}

/* ‚îÄ‚îÄ Join Lobby ‚îÄ‚îÄ */
function joinLobby() {
  const name = $('playerName').value.trim();
  const code = $('joinCode').value.trim().toUpperCase();

  if (!name) return setStatus('joinStatus', 'Enter your name.', 'err');
  if (!code || code.length < 4) return setStatus('joinStatus', 'Enter a valid lobby code.', 'err');

  db.ref('lobbies/' + code).once('value').then(snap => {
    if (!snap.exists()) return setStatus('joinStatus', 'Lobby not found.', 'err');
    if (snap.val()?.gameOver) return setStatus('joinStatus', 'That game has already ended.', 'err');
    const pid = db.ref().push().key;
    myPlayerId = pid;
    return db.ref(`lobbies/${code}/players/${pid}`).set({
      name: name,
      score: 0,
      answers: {}
    }).then(() => {
      lobbyCode = code;
      isHost = false;
      saveSession();
      enterGame(code);
      setStatus('joinStatus', 'Joined!', 'ok');
    });
  }).catch(e => setStatus('joinStatus', 'Error: ' + e.message, 'err'));
}

/* ‚îÄ‚îÄ Enter Game View ‚îÄ‚îÄ */
function enterGame(code) {
  hide('sectionLanding');
  show('sectionGame');
  $('displayCode').textContent = code;

  if (isHost) {
    show('hostControls');
    show('qrBtnRow');
    initQR(code);
  } else {
    show('playerAnswerArea');
  }

  listenToLobby(code);
}

/* ‚îÄ‚îÄ Listen ‚îÄ‚îÄ */
let prevRound = 1;

function listenToLobby(code) {
  db.ref('lobbies/' + code).on('value', snap => {
    const lobby = snap.val();
    if (!lobby) return;

    currentRound = lobby.round || 1;
    roundLocked = lobby.roundLocked !== false;
    const gameOver = lobby.gameOver === true;

    $('roundBadge').textContent = 'Round ' + currentRound;

    if (gameOver) {
      clearSavedSession();
      renderResults(lobby);
      return;
    }

    // Handle transition screen for everyone
    const transition = lobby.transition || {};
    if (transition.active && transition.round === currentRound) {
      if (!isHost) {
        showTransitionOverlay(transition.round, transition.artist || '‚Äî', transition.title || '‚Äî');
      }
    } else if (!transition.active) {
      // Auto-hide transition screen when host clears it (round advanced)
      hide('transitionScreen');
    }

    // If round changed and player, clear their inputs
    if (!isHost && currentRound !== prevRound) {
      clearPlayerInputs();
      prevRound = currentRound;
    }

    // If host, restore song fields for current round
    if (isHost) {
      const roundKey = 'round' + currentRound;
      const song = lobby.songs?.[roundKey] || {};
      $('hostCorrectArtist').value = song.artist || '';
      $('hostCorrectTitle').value = song.title || '';
    }

    renderPlayers(lobby);
    updatePlayerUI(lobby);
  });
}

/* ‚îÄ‚îÄ Host: Save Song Answer to Firebase ‚îÄ‚îÄ */
function saveSongAnswer() {
  if (!isHost || !lobbyCode) return;
  clearTimeout(songSaveTimer);
  $('songSavedNotice').textContent = '';
  songSaveTimer = setTimeout(() => {
    const artist = $('hostCorrectArtist').value.trim();
    const title = $('hostCorrectTitle').value.trim();
    const roundKey = 'round' + currentRound;
    db.ref(`lobbies/${lobbyCode}/songs/${roundKey}`).set({ artist, title }).then(() => {
      $('songSavedNotice').textContent = '‚úì Saved';
      setTimeout(() => { $('songSavedNotice').textContent = ''; }, 2000);
    });
  }, 600);
}

/* ‚îÄ‚îÄ Clear player answer inputs ‚îÄ‚îÄ */
function clearPlayerInputs() {
  $('answerArtist').value = '';
  $('answerTitle').value = '';
  $('answerArtist').disabled = false;
  $('answerTitle').disabled = false;
  $('btnSubmit').disabled = false;
  setStatus('answerStatus', '');
}

/* ‚îÄ‚îÄ Render Player List ‚îÄ‚îÄ */
function renderPlayers(lobby) {
  const list = $('playerList');
  if (!lobby.players) {
    list.innerHTML = '<p style="color:var(--muted);font-size:0.85rem">No players yet.</p>';
    return;
  }

  list.innerHTML = '';

  Object.entries(lobby.players).forEach(([pid, player]) => {
    const div = document.createElement('div');
    div.className = 'player-entry';

    const roundKey = 'round' + currentRound;
    const ans = player.answers?.[roundKey] || {};
    const artistGiven = ans.artistPoint === true;
    const titleGiven = ans.titlePoint === true;

    let answerBlock = '';
    if (isHost) {
      const artistVal = ans.artist ? ans.artist : '‚Äî';
      const titleVal  = ans.title  ? ans.title  : '‚Äî';
      answerBlock = `
        <div class="answer-reveal">
          <div class="label">Artist</div>
          <div class="val ${ans.artist ? '' : 'empty'}">${escHtml(artistVal)}</div>
        </div>
        <div class="answer-reveal">
          <div class="label">Song Title</div>
          <div class="val ${ans.title ? '' : 'empty'}">${escHtml(titleVal)}</div>
        </div>
        <div class="host-row">
          <button class="btn btn-small btn-success" onclick="awardPoint('${pid}','artist')"
            ${artistGiven || roundLocked ? 'disabled' : ''}>
            ${artistGiven ? '‚úì Artist' : 'üé§ +1 Artist'}
          </button>
          <button class="btn btn-small btn-success" onclick="awardPoint('${pid}','title')"
            ${titleGiven || roundLocked ? 'disabled' : ''}>
            ${titleGiven ? '‚úì Title' : 'üéµ +1 Title'}
          </button>
        </div>
      `;
    }

    div.innerHTML = `
      <div class="player-header">
        <span class="player-name">${escHtml(player.name)}</span>
        <span class="player-score">${player.score || 0} pts</span>
      </div>
      ${answerBlock}
    `;
    list.appendChild(div);
  });
}

/* ‚îÄ‚îÄ Update Player UI ‚îÄ‚îÄ */
function updatePlayerUI(lobby) {
  if (isHost) return;

  const roundKey = 'round' + currentRound;
  const myData = lobby.players?.[myPlayerId];
  const myAns = myData?.answers?.[roundKey];
  const alreadySubmitted = myAns?.submitted === true;

  if (roundLocked) {
    show('roundLockedNotice');
    $('answerArtist').disabled = true;
    $('answerTitle').disabled = true;
    $('btnSubmit').disabled = true;
    if (alreadySubmitted) {
      setStatus('answerStatus', '‚úì Answer submitted. Waiting for next round.', 'ok');
    }
  } else {
    hide('roundLockedNotice');
    if (alreadySubmitted) {
      $('answerArtist').disabled = true;
      $('answerTitle').disabled = true;
      $('btnSubmit').disabled = true;
      setStatus('answerStatus', '‚úì Answer submitted!', 'ok');
    } else {
      $('answerArtist').disabled = false;
      $('answerTitle').disabled = false;
      $('btnSubmit').disabled = false;
      if (!$('answerStatus').classList.contains('ok')) {
        setStatus('answerStatus', 'Enter your guesses above.');
      }
    }
  }
}

/* ‚îÄ‚îÄ Submit Answer ‚îÄ‚îÄ */
function submitAnswer() {
  if (!myPlayerId || !lobbyCode) return;

  const artist = $('answerArtist').value.trim();
  const title  = $('answerTitle').value.trim();

  if (!artist && !title) return setStatus('answerStatus', 'Enter at least one answer.', 'err');
  if (roundLocked) return setStatus('answerStatus', 'Round not started yet.', 'err');

  const roundKey = 'round' + currentRound;
  db.ref(`lobbies/${lobbyCode}/players/${myPlayerId}/answers/${roundKey}`).update({
    artist: artist || '',
    title: title || '',
    submitted: true
  }).then(() => {
    setStatus('answerStatus', '‚úì Submitted!', 'ok');
    $('answerArtist').disabled = true;
    $('answerTitle').disabled = true;
    $('btnSubmit').disabled = true;
  }).catch(e => setStatus('answerStatus', 'Error: ' + e.message, 'err'));
}

/* ‚îÄ‚îÄ Host: Award Point ‚îÄ‚îÄ */
function awardPoint(pid, type) {
  if (!isHost || !lobbyCode) return;

  const roundKey = 'round' + currentRound;
  const pointField = type + 'Point';
  const pointPath = `lobbies/${lobbyCode}/players/${pid}/answers/${roundKey}/${pointField}`;

  db.ref(pointPath).once('value').then(snap => {
    if (snap.val() === true) return;
    db.ref(pointPath).set(true);
    db.ref(`lobbies/${lobbyCode}/players/${pid}/score`).transaction(s => (s || 0) + 1);
  });
}

/* ‚îÄ‚îÄ Host: Unlock Round ‚îÄ‚îÄ */
function unlockRound() {
  if (!isHost || !lobbyCode) return;
  db.ref('lobbies/' + lobbyCode).update({ roundLocked: false });
}

/* ‚îÄ‚îÄ Host: Show Transition Screen ‚îÄ‚îÄ */
function showTransitionScreen() {
  if (!isHost) return;

  const roundKey = 'round' + currentRound;
  db.ref(`lobbies/${lobbyCode}/songs/${roundKey}`).once('value').then(snap => {
    const song = snap.val() || {};
    const artist = song.artist || '(no artist entered)';
    const title = song.title || '(no title entered)';

    // Write transition state to Firebase so players see it too
    db.ref('lobbies/' + lobbyCode).update({
      transition: {
        active: true,
        round: currentRound,
        artist: artist,
        title: title
      }
    });

    showTransitionOverlay(currentRound, artist, title);
  });
}

/* ‚îÄ‚îÄ Show transition overlay (shared by host + players) ‚îÄ‚îÄ */
function showTransitionOverlay(round, artist, title) {
  $('tsCorrectArtist').innerHTML = `üé§ <strong>${escHtml(artist)}</strong>`;
  $('tsCorrectTitle').innerHTML = `üéµ <strong>${escHtml(title)}</strong>`;
  $('tsRoundLabel').textContent = 'Round ' + round;
  $('tsNextRoundNum').textContent = round + 1;

  // Show different button for host vs player
  if (isHost) {
    $('tsBtnHost').classList.remove('hidden');
    $('tsBtnPlayer').classList.add('hidden');
  } else {
    $('tsBtnHost').classList.add('hidden');
    $('tsBtnPlayer').classList.remove('hidden');
  }

  show('transitionScreen');
}

/* ‚îÄ‚îÄ Host: Proceed to Next Round ‚îÄ‚îÄ */
function proceedToNextRound() {
  hide('transitionScreen');
  $('hostCorrectArtist').value = '';
  $('hostCorrectTitle').value = '';

  // Clear transition state and advance round
  db.ref('lobbies/' + lobbyCode).transaction(data => {
    if (data) {
      data.round = (data.round || 1) + 1;
      data.roundLocked = true;
      data.transition = { active: false };
    }
    return data;
  });
}

/* ‚îÄ‚îÄ Player: dismiss their own transition screen ‚îÄ‚îÄ */
function playerDismissTransition() {
  hide('transitionScreen');
}

/* ‚îÄ‚îÄ Host: End Game ‚îÄ‚îÄ */
function endGame() {
  if (!isHost || !lobbyCode) return;
  db.ref('lobbies/' + lobbyCode).update({ gameOver: true, roundLocked: true });
}

/* ‚îÄ‚îÄ Render Results ‚îÄ‚îÄ */
let resultsShown = false;
function renderResults(lobby) {
  hide('sectionGame');

  const podiumList = $('podiumList');
  podiumList.innerHTML = '';

  const players = lobby.players ? Object.values(lobby.players) : [];
  players.sort((a, b) => (b.score || 0) - (a.score || 0));

  players.forEach((player, idx) => {
    const rank = idx + 1;
    const entry = document.createElement('div');
    entry.className = `podium-entry rank-${rank <= 3 ? rank : 'other'}`;
    entry.style.animationDelay = `${idx * 0.12}s`;

    const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `#${rank}`;
    entry.innerHTML = `
      <div class="podium-rank">${medal}</div>
      <div class="podium-info">
        <div class="podium-name">${escHtml(player.name)}</div>
        <div class="podium-score">${lobby.round || 1} rounds played</div>
      </div>
      <div class="podium-score-badge">${player.score || 0} pts</div>
    `;
    podiumList.appendChild(entry);
  });

  show('resultsScreen');
  if (!resultsShown) { spawnConfetti(); resultsShown = true; }
}

/* ‚îÄ‚îÄ Close Results ‚îÄ‚îÄ */
function closeResults() {
  hide('resultsScreen');
  show('sectionGame');
}

/* ‚îÄ‚îÄ Confetti ‚îÄ‚îÄ */
function spawnConfetti() {
  const colors = ['#ff4fa3','#ff85c2','#ffd700','#c0185e','#fff','#ff7eb3'];
  for (let i = 0; i < 60; i++) {
    setTimeout(() => {
      const dot = document.createElement('div');
      dot.className = 'confetti-dot';
      dot.style.left = Math.random() * 100 + 'vw';
      dot.style.background = colors[Math.floor(Math.random() * colors.length)];
      dot.style.animationDuration = (2 + Math.random() * 2.5) + 's';
      dot.style.animationDelay = (Math.random() * 0.5) + 's';
      dot.style.width = (6 + Math.random() * 8) + 'px';
      dot.style.height = dot.style.width;
      dot.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
      document.body.appendChild(dot);
      setTimeout(() => dot.remove(), 5000);
    }, i * 40);
  }
}

/* ‚îÄ‚îÄ QR Code ‚îÄ‚îÄ */
let qrGenerated = false;
let qrVisible = false;

function initQR(code) {
  // Build the join URL ‚Äî same page with ?join=CODE pre-filled
  const url = window.location.href.split('?')[0] + '?join=' + code;
  $('qrUrl').textContent = url;

  if (!qrGenerated) {
    new QRCode($('qrContainer'), {
      text: url,
      width: 180,
      height: 180,
      colorDark: '#1a0a12',
      colorLight: '#ffffff',
      correctLevel: QRCode.CorrectLevel.M
    });
    qrGenerated = true;
  }
}

function toggleQR() {
  qrVisible = !qrVisible;
  if (qrVisible) {
    show('qrPanel');
    $('btnToggleQR').textContent = 'üôà Hide QR Code';
  } else {
    hide('qrPanel');
    $('btnToggleQR').textContent = 'üì± Show QR Code';
  }
}

async function exportPDF() {
  const btn = document.querySelector('.res-actions .btn-primary');
  btn.textContent = '‚è≥ Generating‚Ä¶';
  btn.disabled = true;

  try {
    // Fetch full lobby data fresh
    const snap = await db.ref('lobbies/' + lobbyCode).once('value');
    const lobby = snap.val();
    if (!lobby) throw new Error('No lobby data');

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
    const pageW = 210;
    const pageH = 297;
    const margin = 18;
    const contentW = pageW - margin * 2;
    let y = margin;

    const pink = [192, 24, 94];
    const darkBg = [26, 10, 18];
    const lightPink = [255, 230, 243];
    const mutedText = [120, 60, 90];

    function checkPageBreak(needed = 10) {
      if (y + needed > pageH - margin) {
        doc.addPage();
        y = margin;
        drawPageHeader();
      }
    }

    function drawPageHeader() {
      doc.setFillColor(...darkBg);
      doc.rect(0, 0, pageW, 14, 'F');
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(9);
      doc.setTextColor(255, 133, 194);
      doc.text('üéµ Song Quiz ‚Äî Answer Sheet', margin, 9);
      doc.setTextColor(...mutedText);
      doc.text(`Lobby: ${lobbyCode}`, pageW - margin, 9, { align: 'right' });
      y = Math.max(y, 18);
    }

    // ‚îÄ‚îÄ Cover header ‚îÄ‚îÄ
    doc.setFillColor(...darkBg);
    doc.rect(0, 0, pageW, 40, 'F');
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(22);
    doc.setTextColor(...pink);
    doc.text('Song Quiz', margin, 18);
    doc.setFontSize(11);
    doc.setTextColor(255, 133, 194);
    doc.text('Answer Sheet', margin, 27);
    doc.setFontSize(9);
    doc.setTextColor(...mutedText);
    doc.text(`Lobby: ${lobbyCode}  ¬∑  ${new Date().toLocaleDateString('en-GB', { day:'numeric', month:'short', year:'numeric' })}`, margin, 35);
    y = 50;

    const totalRounds = lobby.round || 1;
    const players = lobby.players ? Object.entries(lobby.players) : [];
    const songs = lobby.songs || {};

    for (let r = 1; r <= totalRounds; r++) {
      const roundKey = 'round' + r;
      const song = songs[roundKey] || {};
      const correctArtist = song.artist || '‚Äî';
      const correctTitle = song.title || '‚Äî';

      checkPageBreak(30);

      // Round header bar
      doc.setFillColor(...pink);
      doc.roundedRect(margin, y, contentW, 10, 2, 2, 'F');
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(11);
      doc.setTextColor(255, 255, 255);
      doc.text(`Round ${r}`, margin + 4, y + 7);
      y += 13;

      // Correct answer box
      doc.setFillColor(...lightPink);
      doc.roundedRect(margin, y, contentW, 16, 2, 2, 'F');
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(8);
      doc.setTextColor(...pink);
      doc.text('CORRECT ANSWER', margin + 4, y + 5);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(10);
      doc.setTextColor(...darkBg);
      doc.text(`üé§ ${correctArtist}   üéµ ${correctTitle}`, margin + 4, y + 12);
      y += 20;

      // Player answers table header
      if (players.length > 0) {
        const colW = [48, contentW - 48 - 28 - 28, 28, 28];
        const cols = ['Player', 'Artist / Title', 'Artist', 'Title'];
        const xPositions = [margin, margin + colW[0], margin + colW[0] + colW[1], margin + colW[0] + colW[1] + colW[2]];

        checkPageBreak(8);
        doc.setFillColor(46, 20, 32);
        doc.rect(margin, y, contentW, 7, 'F');
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(7.5);
        doc.setTextColor(255, 133, 194);
        cols.forEach((col, i) => doc.text(col, xPositions[i] + 2, y + 5));
        y += 8;

        players.forEach(([pid, player], idx) => {
          const ans = player.answers?.[roundKey] || {};
          const artistPt = ans.artistPoint === true;
          const titlePt = ans.titlePoint === true;
          const rowH = 8;

          checkPageBreak(rowH + 2);

          // Alternating row bg
          if (idx % 2 === 0) {
            doc.setFillColor(36, 16, 24);
            doc.rect(margin, y, contentW, rowH, 'F');
          }

          doc.setFont('helvetica', 'bold');
          doc.setFontSize(8);
          doc.setTextColor(255, 230, 243);
          doc.text(player.name || 'Unknown', xPositions[0] + 2, y + 5.5);

          // Artist answer
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(200, 180, 190);
          const artistStr = ans.artist || '‚Äî';
          const titleStr = ans.title || '‚Äî';
          const combinedStr = `${artistStr} / ${titleStr}`;
          const truncated = doc.splitTextToSize(combinedStr, colW[1] - 4)[0];
          doc.text(truncated, xPositions[1] + 2, y + 5.5);

          // Point indicators
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          if (artistPt) {
            doc.setTextColor(80, 200, 120);
            doc.text('‚úì', xPositions[2] + 10, y + 5.5, { align: 'center' });
          } else {
            doc.setTextColor(180, 80, 80);
            doc.text('‚úó', xPositions[2] + 10, y + 5.5, { align: 'center' });
          }
          if (titlePt) {
            doc.setTextColor(80, 200, 120);
            doc.text('‚úì', xPositions[3] + 10, y + 5.5, { align: 'center' });
          } else {
            doc.setTextColor(180, 80, 80);
            doc.text('‚úó', xPositions[3] + 10, y + 5.5, { align: 'center' });
          }

          y += rowH;
        });
      }

      y += 10;
    }

    // ‚îÄ‚îÄ Final scores page ‚îÄ‚îÄ
    checkPageBreak(40);
    doc.setFillColor(...darkBg);
    doc.rect(0, y - 2, pageW, 14, 'F');
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(13);
    doc.setTextColor(...pink);
    doc.text('Final Scores', margin, y + 8);
    y += 18;

    const sorted = [...players].sort((a, b) => (b[1].score || 0) - (a[1].score || 0));
    sorted.forEach(([pid, player], idx) => {
      checkPageBreak(10);
      const medals = ['ü•á', 'ü•à', 'ü•â'];
      const medal = medals[idx] || `#${idx + 1}`;
      doc.setFont('helvetica', idx === 0 ? 'bold' : 'normal');
      doc.setFontSize(10);
      doc.setTextColor(255, 230, 243);
      doc.text(`${medal}  ${player.name}`, margin + 4, y);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(...pink);
      doc.text(`${player.score || 0} pts`, pageW - margin, y, { align: 'right' });
      y += 9;
    });

    doc.save(`song-quiz-${lobbyCode}-answers.pdf`);
  } catch (err) {
    console.error(err);
    alert('PDF export failed: ' + err.message);
  }

  btn.textContent = 'üìÑ Export Answer Sheet (PDF)';
  btn.disabled = false;
}

/* ‚îÄ‚îÄ XSS protection ‚îÄ‚îÄ */
function escHtml(str) {
  return String(str)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;');
}
</script>
</body>
</html>
